<!DOCTYPE html>
<html>
<head>
    <title>Voice Stream</title>
</head>
<body>
    <h1>Voice Streaming Demo</h1>
    <button id="start">Start Streaming</button>
    <button id="stop" disabled>Stop Streaming</button>
    <div id="messages"></div>
    <audio id="audioPlayer" controls></audio>

    <script>
        const ws = new WebSocket((window.location.protocol === 'https:' ? 'wss://' : 'ws://') + window.location.host + '/ws/voice/');
        let mediaRecorder;
        let audioContext;
        let audioQueue = [];
        let audioPlayer;
        let isPlaying = false;
        let currentAudioURL = null;

        ws.onopen = () => {
            console.log("WebSocket connection opened");
            audioContext = new (window.AudioContext || window.webkitAudioContext)();
            audioPlayer = document.getElementById('audioPlayer');
            audioPlayer.addEventListener('ended', playNextAudio);
        }

        ws.onmessage = (event) => {
            if (event.data instanceof Blob) {
                 console.log("Received audio data");
                audioQueue.push(event.data);
                if (!isPlaying) {
                    playNextAudio();
                }

            } else {
                const data = JSON.parse(event.data);
                console.log("Received text data", data)
                if(data.message){
                    appendMessage(data.message);
                }

            }
        };


        ws.onerror = (error) => {
            console.error("WebSocket error:", error);
        };

        ws.onclose = (event) => {
            console.log('WebSocket closed', event);
        };

        function appendMessage(message) {
            const messagesDiv = document.getElementById('messages');
            const messageDiv = document.createElement('p');
            messageDiv.textContent = message;
            messagesDiv.appendChild(messageDiv);
        }

           function playNextAudio() {
            if (audioQueue.length === 0) {
                isPlaying = false;
                return;
            }

            // Revoke the current audio URL only when next audio starts to play
            if(currentAudioURL) {
                URL.revokeObjectURL(currentAudioURL);
            }

            const audioBlob = audioQueue.shift();
            currentAudioURL = URL.createObjectURL(audioBlob);
            audioPlayer.src = currentAudioURL;
            isPlaying = true;
            audioPlayer.play();

        }

        document.getElementById('start').addEventListener('click', async () => {
            const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
            mediaRecorder = new MediaRecorder(stream);
            mediaRecorder.start();

            mediaRecorder.ondataavailable = (event) => {
                if (ws.readyState === WebSocket.OPEN) {
                    ws.send(event.data);
                }
            };

            document.getElementById('start').disabled = true;
            document.getElementById('stop').disabled = false;
        });

        document.getElementById('stop').addEventListener('click', () => {
            mediaRecorder.stop();
            document.getElementById('start').disabled = false;
            document.getElementById('stop').disabled = true;
        });
    </script>
</body>
</html>